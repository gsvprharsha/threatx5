# Introduction

Wannacry ransomware gained widespread attention in May of 2017, after it caused major disruptions worldwide. This strain of malware particularly targeted computers that ran the <a href="https://en.wikipedia.org/wiki/Microsoft_Windows" style="color:#60A5FA; font-weight:bold;">Windows</a> Operating System. It exploited the vulnerability called EternalBlue, a type of SMB Vulnerability [[1](https://en.wikipedia.org/wiki/WannaCry_ransomware_attack)].

Once it spread, WannaCry quickly infected hundreds of thousands of computers in over 150 countries, making it one of the most major ransomware attacks in recent history. The ransomware takes advantage of this vulnerability to compromise Windows machines, load malware, and propagate to other machines in a network. The attack uses **SMB version 1** and **TCP port 445** to propagate [[2](https://cloud.google.com/blog/topics/threat-intelligence/smb-exploited-wannacry-use-of-eternalblue)].

<br>

# Timeline

The following table gives a broad record of events of the attack [[1](https://en.wikipedia.org/wiki/WannaCry_ransomware_attack)].

<br>

<div style="padding-left: 50px; padding-right: 50px;">
  <table style="border-collapse: collapse; width: 100%; border: 1px solid white; font-size: small;">
    <thead>
      <tr>
        <th style="border: 1px solid white; padding: 8px; font-size: medium; text-align: center">Date and Timestamp</th>
        <th style="border: 1px solid white; padding: 8px; font-size: medium; text-align: center">Event</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">14 March 2017</td>
        <td style="border: 1px solid white; padding: 8px;">Microsoft releases security bulletin <a href="https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010">MS17-010</a>, addressing the SMB vulnerability exploited by EternalBlue.</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">14 April 2017</td>
        <td style="border: 1px solid white; padding: 8px;">The Shadow Brokers leak the EternalBlue exploit and DoublePulsar backdoor tool.</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">9 May 2017</td>
        <td style="border: 1px solid white; padding: 8px;">RiskSense publishes proof-of-concept code for CVE-2017-0144 on GitHub.</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">12 May 2017, 07:44 UTC</td>
        <td style="border: 1px solid white; padding: 8px;">WannaCry ransomware attack begins, with initial infection likely in Asia via an exposed SMB port.</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">12 May 2017, 15:03 UTC</td>
        <td style="border: 1px solid white; padding: 8px;">Marcus Hutchins registers the kill switch domain, significantly slowing the spread of WannaCry.</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">13 May 2017</td>
        <td style="border: 1px solid white; padding: 8px;">Microsoft releases out-of-band security updates for unsupported systems, including Windows XP and Windows Server 2003.</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">14 May 2017</td>
        <td style="border: 1px solid white; padding: 8px;">A first variant of WannaCry with a new kill switch appears. Matt Suiche registers the second kill switch domain.</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">15 May 2017</td>
        <td style="border: 1px solid white; padding: 8px;">A second variant of WannaCry with a third kill switch is identified. Check Point registers the third kill switch domain.</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">19 May 2017</td>
        <td style="border: 1px solid white; padding: 8px;">Mirai botnet variant attempts a DDoS attack on the WannaCry kill-switch domain.</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">22 May 2017</td>
        <td style="border: 1px solid white; padding: 8px;">Marcus Hutchins protects the kill-switch domain by switching to a cached version to handle higher traffic.</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">August 2018</td>
        <td style="border: 1px solid white; padding: 8px;">A new variant of WannaCry forces TSMC to shut down several chip-fabrication factories after infecting 10,000 machines.</td>
      </tr>
    </tbody>
  </table>
</div>

<br>

# Characteristics

The WannaCry ransomware is known for its distinctive characteristics that contributed to its rapid spread and widespread impact. Among these, the exploitation of the <a href="https://en.wikipedia.org/wiki/EternalBlue" style="color:#60A5FA; font-weight:bold;">EternalBlue</a> vulnerability in Windows systems stands out as a critical factor, allowing the malware to propagate across networks. Below are some of the key characteristics that define this ransomware.

<br>

## EternalBlue Exploit

The SMBv1 server in several Microsoft Windows versions, including 

<li style="font-size: small;">Vista SP2</li>
<li style="font-size: small;">Windows Server 2008 SP2 and R2 SP1</li>
<li style="font-size: small;">Windows 7 SP1</li>
<li style="font-size: small;">Windows 8.1</li>
<li style="font-size: small;">Windows Server 2012 (original and R2)</li>
<li style="font-size: small;">Windows RT 8.1</li>
<li style="font-size: small;">Windows 10 (versions Gold, 1511, and 1607)</li>
<li style="font-size: small;">Windows Server 2016</li>

has a vulnerability that lets attackers run unauthorized code. This happens when the server processes specially crafted packets. This flaw is distinct from the vulnerabilities identified as CVE-2017-0143, CVE-2017-0145, CVE-2017-0146, and CVE-2017-0148 [[3](https://nvd.nist.gov/vuln/detail/CVE-2017-0144)].

<br>

## Working of Wannacry

WannaCry is a modular ransomware that uses advanced techniques to spread and encrypt data on targeted systems. Here's how it operates [[2](https://cloud.google.com/blog/topics/threat-intelligence/smb-exploited-wannacry-use-of-eternalblue)] [[8](https://blog.talosintelligence.com/wannacry/)]:

<br>


### Initial Infection
WannaCry begins with the execution of a file named ``mssecsvc.exe``. This file drops and runs ``tasksche.exe``, which checks the kill switch domains to determine whether to proceed. If no kill switch is detected, the malware creates a persistent service named ``mssecsvc2.0``. This service executes mssecsvc.exe with a different entry point, triggering two threads:

<br>

- 1.&nbsp;WannaCry begins with the execution of a file named ``mssecsvc.exe``. This file drops and runs ``tasksche.exe``, which checks the kill switch domains to determine whether to proceed. If no kill switch is detected, the malware creates a persistent service named ``mssecsvc2.0``. This service executes ``mssecsvc.exe`` with a different entry point, triggering two threads:

    - a) The first thread scans the local subnet for machines and attempts to connect to **TCP port 445 (SMB)**.
    - b) The second thread generates random IP addresses and tries to connect to SMB on those addresses.

- The malware exploits the SMB vulnerability known as EternalBlue (addressed by Microsoft in MS17-010) to install a backdoor named ``DOUBLEPULSAR``. This backdoor allows the malware to deploy itself on new machines.

<br>

### Propogation

After establishing a connection with a vulnerable system, WannaCry connects to the ``IPC$`` share on the remote machine.

<br>
<figure class="image-caption">
  <img src="/images/malware/wannacry/connecting_to_IPC.png" alt="Description of the image">
  <figcaption>Fig-1: Connecting to the IPC$ share <a href="https://cloud.google.com/blog/topics/threat-intelligence/smb-exploited-wannacry-use-of-eternalblue/" style="color:#60A5FA; font-weight:bold;"> Image Source: Google Cloud (Mandiant) [2]</a> </figcaption>
</figure>

The malware then sends a specially crafted NT Trans request to exploit the SMB server's vulnerability. This request contains NOP sequences to prepare the server for exploitation.

<br>
<figure class="image-caption">
  <img src="/images/malware/wannacry/preparing_server_for_exploit.png" alt="Description of the image">
  <figcaption>Fig-1: Connecting to the IPC$ share <a href="https://cloud.google.com/blog/topics/threat-intelligence/smb-exploited-wannacry-use-of-eternalblue/" style="color:#60A5FA; font-weight:bold;"> Image Source: Google Cloud (Mandiant) [2]</a> </figcaption>
</figure>

Next, WannaCry sends malformed Secondary ``Trans2`` requests. These trigger the vulnerability and include shellcode and the encrypted ransomware payload.

<br>
<figure class="image-caption">
  <img src="/images/malware/wannacry/overflow.png" alt="Description of the image">
  <figcaption>Fig-1: Connecting to the IPC$ share <a href="https://cloud.google.com/blog/topics/threat-intelligence/smb-exploited-wannacry-use-of-eternalblue/" style="color:#60A5FA; font-weight:bold;"> Image Source: Google Cloud (Mandiant) [2]</a> </figcaption>
</figure>

Once the payload is executed, the malware installs the mssecsvc service on the new machine, enabling further scanning and propagation.

<br>

### Encryption Process

WannaCry uses ``tasksche.exe`` to identify and encrypt files. It scans local drives, network shares, and removable storage for specific file types listed in its code. The encryption uses **2048-bit RSA keys**, rendering the files inaccessible without the decryption key.

- a.&nbsp;While encrypting, the malware creates a directory named ``Tor/``, which stores ``tor.exe`` and its associated DLLs.
- b.&nbsp;It also drops ``taskdl.exe`` to delete temporary files and ``taskse.exe`` to launch ``@wanadecryptor@.exe``, which displays the ransom note.

<br>

### The Communication

WannaCry uses the Tor network for anonymity. The ``@wanadecryptor@.exe`` executable connects to Tor nodes, allowing the ransomware operators to communicate without revealing their location.

<br>

### System Alterations

WannaCry deletes shadow copies on the victimâ€™s machine to prevent recovery. It achieves this using tools like ``WMIC.exe``, ``vssadmin.exe``, and ``cmd.exe``. Additionally, it modifies file attributes with ``attrib.exe`` and grants full access permissions using ``icacls.exe``.

<br>

### Ransom Note

After encryption, WannaCry displays a ransom note through ``@wanadecryptor@.exe``. This executable instructs victims to pay in Bitcoin for file decryption.

<br>

# The Kill Switch

WannaCry has a kill switch that checks if a specific domain **``iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com``** is active. If the domain is found, the ransomware stops. If the domain is not registered or cannot be reached, the malware continues to encrypt files and spread to other systems.

<br>

# The IOCs
The following table contains a list of IOCs for Wannacry Ransomware [4]

<div style="padding-left: 50px; padding-right: 50px;" class="table-container">
  <table style="border-collapse: collapse; width: 100%; border: 1px solid white; font-size: small;">
    <thead>
      <tr>
        <th style="border: 1px solid white; padding: 8px; font-size: medium; text-align: center">Type</th>
        <th style="border: 1px solid white; padding: 8px; font-size: medium; text-align: center">IOC</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">IPv4</td>
        <td style="border: 1px solid white; padding: 8px;">197[.]231[.]221[.]211</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">IPv4</td>
        <td style="border: 1px solid white; padding: 8px;">128[.]31[.]0[.]39</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">IPv4</td>
        <td style="border: 1px solid white; padding: 8px;">149[.]202[.]160[.]69</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">IPv4</td>
        <td style="border: 1px solid white; padding: 8px;">46[.]101[.]166[.]19</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">IPv4</td>
        <td style="border: 1px solid white; padding: 8px;">91[.]121[.]65[.]179</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://www[.]btcfrog[.]com/qr/bitcoinpng[.]php?address</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://www[.]rentasyventas[.]com/incluir/rk/imagenes[.]html</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://www[.]rentasyventas[.]com/incluir/rk/imagenes[.]html?retencion=081525418</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://gx7ekbenv2riucmf[.]onion</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://57g7spgrzlojinas[.]onion</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://xxlvbrloxvriy2c5[.]onion</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://76jdd2ir2embyv47[.]onion</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://cwwnhwhlz52maqm7[.]onion</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://197[.]231[.]221[.]211 Port:9001</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://128[.]31[.]0[.]39 Port:9191</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://149[.]202[.]160[.]69 Port:9001</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://46[.]101[.]166[.]19 Port:9090</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">URL</td>
        <td style="border: 1px solid white; padding: 8px;">hxxp://91[.]121[.]65[.]179 Port:9001</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">5a89aac6c8259abbba2fa2ad3fcefc6e</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">05da32043b1e3a147de634c550f1954d</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">8e97637474ab77441ae5add3f3325753</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">c9ede1054fef33720f9fa97f5e8abe49</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">f9cee5e75b7f1298aece9145ea80a1d2</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">638f9235d038a0a001d5ea7f5c5dc4ae</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">80a2af99fd990567869e9cf4039edf73</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">c39ed6f52aaa31ae0301c591802da24b</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">db349b97c37d22f5ea1d1841e3c89eb4</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">f9992dfb56a9c6c20eb727e6a26b0172</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">46d140a0eb13582852b5f778bb20cf0e</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">5bef35496fcbdbe841c82f4d1ab8b7c2</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">3c6375f586a49fc12a4de9328174f0c1</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">246c2781b88f58bc6b0da24ec71dd028</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">b7f7ad4970506e8547e0f493c80ba441</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">2b4e8612d9f8cdcf520a8b2e42779ffa</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">c61256583c6569ac13a136bfd440ca09</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">31dab68b11824153b4c975399df0354f</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">54a116ff80df6e6031059fc3036464df</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">d6114ba5f10ad67a4131ab72531f02da</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">05a00c320754934782ec5dec1d5c0476</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">f107a717f76f4f910ae9cb4dc5290594</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">7f7ccaa16fb15eb1c7399d422f8363e8</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">84c82835a5d21bbcf75a61706d8ab549</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">bec0b7aff4b107edd5b9276721137651</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">86721e64ffbd69aa6944b9672bcabb6d</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">509c41ec97bb81b0567b059aa2f50fe8</td>
      </tr>
      <tr>
        <td style="border: 1px solid white; padding: 8px;">MD5</td>
        <td style="border: 1px solid white; padding: 8px;">8db349b97c37d22f5ea1d1841e3c89eb</td>
      </tr>
    </tbody>
  </table>
</div>

<br>

# References
1) WannaCry ransomware attack - Wikipedia **([Link](https://en.wikipedia.org/wiki/WannaCry_ransomware_attack))**
2) SMB Exploited: WannaCry Use of "EternalBlue" - Google Cloud **([Link](https://cloud.google.com/blog/topics/threat-intelligence/smb-exploited-wannacry-use-of-eternalblue/))**
3) CVE-2017-0144 Detail - NIST **([Link](https://nvd.nist.gov/vuln/detail/CVE-2017-0144))**
4) Wannacry IOCs and Technical details - Critical Start **([Link](https://www.criticalstart.com/wannacry-iocs-and-technical-details/))**
5) Indicators Associated With WannaCry Ransomware - CISA **([Link](https://www.cisa.gov/news-events/alerts/2017/05/12/indicators-associated-wannacry-ransomware))**
6) RANSOM_MS17-010_Wannacrypt.yar - YARA-Rules **([Link](https://github.com/Yara-Rules/rules/blob/master/malware/RANSOM_MS17-010_Wannacrypt.yar))**
7) MITRE ATT&CK Framework for WannaCry - MITRE ATT&CK **([Link](https://attack.mitre.org/software/S0366/))**
8) Player 3 Has Entered the Game: Say Hello to 'WannaCry' - Cisco Talos (Talos Intelligence) **([Link](https://blog.talosintelligence.com/wannacry/))**